<style>
  #airplane-layout .seat {
    stroke: rgba(0, 0, 0, 0.5);
    fill: rgba(0, 0, 0, 0.1);
  }

  #airplane-layout .button {
    padding: 4px 12px;
    margin: 3px;
    background-color: #5f5f5f;
    color: white;
    border-radius: 5px;
    cursor: pointer;
  }

  #airplane-layout .hidden {
    display: none;
  }

  #airplane-layout .passenger {
    stroke: #20ac53;
    fill: rgba(90, 255, 67, 0.5);
  }

  #airplane-layout .interchanging {
    stroke: #ac602e;
    fill: rgba(255, 108, 51, 0.5);
  }

  #airplane-layout .passenger.seated {
    stroke: #2b7cac;
    fill: rgba(109, 167, 255, 0.57);
  }

  #airplane-layout .passenger.wait {
    stroke: #ac4e55;
    fill: rgba(255, 50, 70, 0.6);
  }

  #airplane-layout .time {
    font-family: Consolas, "Andale Mono WT", "Andale Mono", "Lucida Console", "Lucida Sans Typewriter", "DejaVu Sans Mono", "Bitstream Vera Sans Mono", "Liberation Mono", "Nimbus Mono L", Monaco, "Courier New", Courier, monospace;
  }

</style>
<div id="airplane-layout">
  <div style="display:flex;">
    <div>Time:&nbsp;</div>
    <div class="time"></div>
    <div style="flex-grow: 1"></div>
    <div class="button" data-delta="-30">-30</div>
    <div class="button" data-delta="-1">-1</div>
    <div class="button play-button" data-delta="0">Play</div>
    <div class="button" data-delta="1">+1</div>
    <div class="button" data-delta="30">+30</div>
  </div>
</div>

<script>
  (function () {
    var svgContainer = d3.select($('#airplane-layout')[0])
      .append("svg")
      .attr('version', '1.1');

    var interval;
    var delta = -30;
    var passenger_count = window.project.passenger_count;
    var max_seats = window.project.status.max_seats_in_row;
    var maxTime = window.project.status.elapsed;

    var time = 0;
    var passengers = [];
    var seat_positions = [];
    var aisle_positions = [];

    function draw_seats() {
      var sections = window.project.settings.airplane;
      var xOff = Math.abs(delta);
      var height = 0;

      function addRowOfSeats(count, yOff, maxCount) {
        var seatIndex;
        var padding = Math.min(0, 0.5 * delta * (maxCount - count));

        yOff += padding;
        for (seatIndex = 0; seatIndex < count; seatIndex++) {
          seat_positions.push({'x': xOff, 'y': yOff});

          var circle = svgContainer.append('circle')
            .attr('cx', xOff)
            .attr('cy', yOff)
            .attr('r', 0.4 * Math.abs(delta))
            .classed('seat', true);
          yOff += delta;
          height = Math.min(yOff, height);
        }
        return yOff + padding;
      }

      sections.forEach(function (section) {
        var rowIndex, i, yOff;

        for (rowIndex = 0; rowIndex < section.rows; rowIndex++) {
          yOff = delta;
          for (i = 0; i < section.seats.length; i++) {
            yOff = addRowOfSeats(
              section.seats[i],
              yOff,
              max_seats[i]
            );

            if (i < section.seats.length - 1) {
              aisle_positions.push({'x': xOff, 'y': yOff});
              yOff += delta;
            }

          }
          xOff += Math.abs(delta);
        }
      });

      svgContainer.attr(
        'viewBox',
        '0 ' + height + ' ' + xOff + ' ' + Math.abs(height)
      );
    }

    function draw_passengers() {
      var i;

      for (i = 0; i < passenger_count; i++) {
        passengers.push(svgContainer.append('circle')
          .attr('cx', aisle_positions[0].x)
          .attr('cy', aisle_positions[0].y)
          .attr('r', 6)
          .classed("passenger", true)
          .classed("hidden", true)
        );
      }
    }

    function displayTime(raw) {
      var hours = Math.floor(raw / 3600);
      raw -= hours * 3600;
      hours = (hours < 10 ? '0' : '') + hours;
      var minutes = Math.floor(raw / 60);
      raw -= minutes * 60;
      minutes = (minutes < 10 ? '0' : '') + minutes;
      var seconds = Math.floor(raw);
      seconds = (seconds < 10 ? '0' : '') + seconds;
      return hours + ':' + minutes + ':' + seconds;
    }

    /**
     *
     */
    function update(newTime) {
      var lastTime = time;
      var progs = window.project.progress;

      time = Math.max(0, Math.min(newTime, maxTime));
      if (lastTime === time) {
        return false;
      }

      $('#airplane-layout .time').html(displayTime(time));

      progs.forEach(function (positions, index) {
        var progress = positions[time].split(':');
        var state = progress[0];
        var pos = isNaN(progress[1]) ? -1 : parseInt(progress[1], 10);
        var passenger = passengers[index];

        function move(x, y) {
          var duration = (interval ? 70 : 500);

          if (time > lastTime) {
            return passenger
              .transition().duration(duration).attr('cx', x)
              .transition().duration(duration).attr('cy', y);
          }

          return passenger
            .transition().duration(duration).attr('cy', y)
            .transition().duration(duration).attr('cx', x);
        }

        if (time > 0 && state === 'Q') {
          passenger
            .classed('hidden', pos < 0)
            .classed('wait', positions[time - 1] === positions[time])
            .classed('interchanging', false)
            .classed('seated', false);
        }

        if (state === 'I') {
          passenger
              .classed('hidden', false)
              .classed('seated', false)
              .classed('interchanging', true)
              .classed('wait', false);
        }

        if (state === 'O') {
          passenger
              .classed('hidden', false)
              .classed('seated', false)
              .classed('interchanging', true)
              .classed('wait', false);
          return;
        }

        if (state === 'S') {
          passenger
            .classed('hidden', false)
            .classed('seated', true)
            .classed('interchanging', false)
            .classed('wait', false);

          move(
            seat_positions[index].x,
            seat_positions[index].y
          );
          return;
        }

        move(
           aisle_positions[Math.max(0, pos)].x,
           aisle_positions[Math.max(0, pos)].y
        );
      });

      return true;
    }

    draw_seats();
    draw_passengers();
    update(0);


    /**
     *
     */
    function start_animation() {
      if (time === maxTime) {
        update(0);
      }

      $('#airplane-layout .play-button').html('Pause');
      if (interval) {
        return;
      }

      interval = setInterval(function () {
        if (!update(time + 1)) {
          stop_animation();
        }
      }, 150);
    }


    /**
     *
     */
    function stop_animation() {
      $('#airplane-layout .play-button').html('Play');
      if (!interval) {
        return;
      }

      clearInterval(interval);
      interval = null;
    }


    $('#airplane-layout .button').click(function (event) {
      var e = $(event.currentTarget);
      var change = parseInt(e.attr('data-delta'));
      if (change !== 0) {
        return update(time + change);
      }

      if (interval) {
        return stop_animation();
      }

      return start_animation();
    });

  }());
</script>
