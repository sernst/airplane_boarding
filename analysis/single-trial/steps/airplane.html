<style>

  .centered {
    display: flex;
    align-content: center;
    align-items: center;
    justify-content: center;
    margin-right: 0.75em;
  }

  #airplane-layout .seat {
    stroke: rgba(0, 0, 0, 0.5);
    fill: rgba(0, 0, 0, 0.1);
  }

  #airplane-controls .button {
    display: flex;
    align-content: center;
    align-items: center;
    justify-content: center;
    padding: 6px 20px;
    margin: 0 3px;
    background-color: #5f5f5f;
    color: white;
    border-radius: 5px;
    cursor: pointer;
    -webkit-touch-callout: none; /* iOS Safari */
    -webkit-user-select: none; /* Chrome/Safari/Opera */
    -khtml-user-select: none; /* Konqueror */
    -moz-user-select: none; /* Firefox */
    -ms-user-select: none; /* Internet Explorer/Edge */
    user-select: none;
  }

  #airplane-layout .hidden {
    display: none;
  }

  #airplane-layout .passenger {
    stroke: #20ac53;
    fill: rgba(90, 255, 67, 0.5);
  }

  #airplane-layout .interchanging {
    stroke: #ac602e;
    fill: rgba(255, 108, 51, 0.5);
  }

  #airplane-layout .passenger.seated {
    stroke: #2b7cac;
    fill: rgba(109, 167, 255, 0.57);
  }

  #airplane-layout .passenger.wait {
    stroke: #ac4e55;
    fill: rgba(255, 50, 70, 0.6);
  }

  #airplane-layout .passenger.seating {
    stroke: #9464ac;
    fill: rgba(203, 135, 255, 0.6);
  }

  #airplane-layout .time {
    font-family: Consolas, "Andale Mono WT", "Andale Mono", "Lucida Console", "Lucida Sans Typewriter", "DejaVu Sans Mono", "Bitstream Vera Sans Mono", "Liberation Mono", "Nimbus Mono L", Monaco, "Courier New", Courier, monospace;
  }

  #airplane-layout .speed-box {
    font-family: Consolas, "Andale Mono WT", "Andale Mono", "Lucida Console", "Lucida Sans Typewriter", "DejaVu Sans Mono", "Bitstream Vera Sans Mono", "Liberation Mono", "Nimbus Mono L", Monaco, "Courier New", Courier, monospace;
    opacity: 0.5;
  }

</style>
<div id="airplane-layout">
  <div style="display:flex;">
    <div style="display:flex;flex-direction: column">
      <div style="font-size: 1.3em; font-weight: bold">
        Time: <span class="time">00:00:00</span>
        <span class="speed-box">(Rate: <span class="speed"></span>x)</span>
      </div>

      <div style="display:flex">
        <div class="centered">
          <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
            <path d="M24 24H0V0h24v24z" fill="none"/>
            <circle cx="12" cy="12" class="passenger" r="8"/>
          </svg>
          Moving
        </div>

        <div class="centered">
          <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
            <path d="M24 24H0V0h24v24z" fill="none"/>
            <circle cx="12" cy="12" class="passenger wait" r="8"/>
          </svg>
          Waiting
        </div>

        <div class="centered">
          <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
            <path d="M24 24H0V0h24v24z" fill="none"/>
            <circle cx="12" cy="12" class="passenger seating" r="8"/>
          </svg>
          Seating
        </div>

        <div class="centered">
          <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
            <path d="M24 24H0V0h24v24z" fill="none"/>
            <circle cx="12" cy="12" class="passenger seated" r="8"/>
          </svg>
          Seated
        </div>

        <div class="centered">
          <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
            <path d="M24 24H0V0h24v24z" fill="none"/>
            <circle cx="12" cy="12" class="passenger interchanging" r="8"/>
          </svg>
          Swapping
        </div>
      </div>
    </div>

    <div style="flex-grow: 1"></div>
  </div>
</div>


<div id="airplane-controls" style="display: flex">
  <div style="flex-grow: 1"></div>

  <div class="button" data-delta="-30">
    <i class="material-icons md-large">replay_30</i>
  </div>
  <div class="button" data-delta="-1">
    <i class="material-icons md-large">fast_rewind</i>
  </div>
  <div class="button play-button" data-delta="0" data-role="toggle">
    <i class="material-icons md-large icon">play_arrow</i>
  </div>
  <div class="button" data-delta="1">
    <i class="material-icons md-large">fast_forward</i>
  </div>
  <div class="button" data-delta="30">
    <i class="material-icons md-large">forward_30</i>
  </div>
  <div class="button speed-change" data-delta="0" data-role="slower">
    <i class="material-icons md-large">arrow_drop_down slow_motion_video</i>
  </div>
  <div class="button speed-change" data-delta="0" data-role="faster">
    <i class="material-icons md-large">arrow_drop_up slow_motion_video</i>
  </div>
</div>

<script>
  (function () {
    var svgContainer = d3.select($('#airplane-layout')[0])
      .append("svg")
      .attr('version', '1.1');

    var playSpeed = 160;
    var interval;
    var delta = -30;
    var passenger_count = window.project.passenger_count;
    var max_seats = window.project.status.max_seats_in_row;
    var maxTime = window.project.status.elapsed;

    var time = 0;
    var passengers = [];
    var seat_positions = [];
    var aisle_positions = [];

    function draw_seats() {
      var sections = window.project.settings.airplane;
      var xOff = Math.abs(delta);
      var height = 0;

      function addRowOfSeats(count, yOff, maxCount) {
        var seatIndex;
        var padding = Math.min(0, 0.5 * delta * (maxCount - count));

        yOff += padding;
        for (seatIndex = 0; seatIndex < count; seatIndex++) {
          seat_positions.push({'x': xOff, 'y': yOff});

          var circle = svgContainer.append('circle')
            .attr('cx', xOff)
            .attr('cy', yOff)
            .attr('r', 0.4 * Math.abs(delta))
            .classed('seat', true);
          yOff += delta;
          height = Math.min(yOff, height);
        }
        return yOff + padding;
      }

      sections.forEach(function (section) {
        var rowIndex, i, yOff;

        for (rowIndex = 0; rowIndex < section.rows; rowIndex++) {
          yOff = delta;
          for (i = 0; i < section.seats.length; i++) {
            yOff = addRowOfSeats(
              section.seats[i],
              yOff,
              max_seats[i]
            );

            if (i < section.seats.length - 1) {
              aisle_positions.push({'x': xOff, 'y': yOff});
              yOff += delta;
            }

          }
          xOff += Math.abs(delta);
        }
      });

      svgContainer.attr(
        'viewBox',
        '0 ' + height + ' ' + xOff + ' ' + Math.abs(height)
      );
    }

    function draw_passengers() {
      var i;

      for (i = 0; i < passenger_count; i++) {
        passengers.push(svgContainer.append('circle')
          .attr('cx', aisle_positions[0].x)
          .attr('cy', aisle_positions[0].y)
          .attr('r', 6)
          .classed("passenger", true)
          .classed("hidden", true)
        );
      }
    }

    function displayTime(raw) {
      var hours = Math.floor(raw / 3600);
      raw -= hours * 3600;
      hours = (hours < 10 ? '0' : '') + hours;
      var minutes = Math.floor(raw / 60);
      raw -= minutes * 60;
      minutes = (minutes < 10 ? '0' : '') + minutes;
      var seconds = Math.floor(raw);
      seconds = (seconds < 10 ? '0' : '') + seconds;
      return hours + ':' + minutes + ':' + seconds;
    }

    /**
     *
     */
    function update(newTime) {
      var lastTime = time;
      var progs = window.project.progress;

      time = Math.max(0, Math.min(newTime, maxTime));
      if (newTime > 0 && lastTime === time) {
        return false;
      }

      $('#airplane-layout .time').html(displayTime(time));
      $('#airplane-layout .speed').html(
          (0.01 * Math.round(100 * 1000/playSpeed)).toFixed(2)
      );

      progs.forEach(function (positions, index) {
        var waiting, seating;
        var passenger = passengers[index];

        var progress = positions[time].split(':');
        var state = progress[0];
        var pos = isNaN(progress[1]) ? -1 : parseInt(progress[1], 10);

        var final = positions[positions.length - 1].split(':');
        var finalPos = parseInt(final[1], 10);

        function move(x, y) {
          var duration = (interval ? Math.floor(0.4 * playSpeed) : 500);

          if (time > lastTime) {
            return passenger
              .transition().duration(duration).attr('cx', x)
              .transition().duration(duration).attr('cy', y);
          }

          return passenger
            .transition().duration(duration).attr('cy', y)
            .transition().duration(duration).attr('cx', x);
        }

        if (time > 0 && state === 'Q') {
          waiting = positions[time - 1] === positions[time];
          seating = waiting && (finalPos === pos);

          passenger
            .classed('hidden', pos < 0)
            .classed('seating', seating)
            .classed('wait', !seating && waiting)
            .classed('interchanging', false)
            .classed('seated', false);
        }

        if (state === 'I') {
          passenger
              .classed('hidden', false)
              .classed('seated', false)
              .classed('seating', false)
              .classed('interchanging', true)
              .classed('wait', false);
        }

        if (state === 'O') {
          passenger
              .classed('hidden', false)
              .classed('seated', false)
              .classed('seating', false)
              .classed('interchanging', true)
              .classed('wait', false);
          return;
        }

        if (state === 'S') {
          passenger
            .classed('hidden', false)
            .classed('seated', true)
            .classed('seating', false)
            .classed('interchanging', false)
            .classed('wait', false);

          move(
            seat_positions[index].x,
            seat_positions[index].y
          );
          return;
        }

        move(
           aisle_positions[Math.max(0, pos)].x,
           aisle_positions[Math.max(0, pos)].y
        );
      });

      return true;
    }

    draw_seats();
    draw_passengers();
    update(0);

    /**
     *
     */
    function start_animation() {
      if (time === maxTime) {
        update(0);
      }

      $('#airplane-controls .play-button .icon').html('pause');
      if (interval) {
        return;
      }

      interval = setInterval(function () {
        if (!update(time + 1)) {
          stop_animation();
        }
      }, playSpeed);
    }

    /**
     *
     */
    function stop_animation() {
      $('#airplane-controls .play-button .icon').html('play_arrow');
      if (!interval) {
        return;
      }

      clearInterval(interval);
      interval = null;
    }

    var delayTimeout;

    $('#airplane-controls .button').click(function (event) {
      var e = $(event.currentTarget);
      var change = parseInt(e.attr('data-delta'));
      var role;

      if (delayTimeout) {
        clearTimeout(delayTimeout);
      }

      if (change !== 0) {
        return update(time + change);
      }

      role = e.attr('data-role');
      if (role === 'slower') {
        playSpeed += 20;
      } else if (role === 'faster') {
        playSpeed = Math.max(40, playSpeed - 20);
      } else if (role == 'toggle') {
        return interval ? stop_animation() : start_animation();
      }

      stop_animation();

      delayTimeout = setTimeout(start_animation, 2 * playSpeed);
    });

    update(0);
  }());
</script>
